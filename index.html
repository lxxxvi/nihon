<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Nihon</title>

    <script type="text/javascript">
      const translations = {
        "hiragana-vowels": [
          { "latin": "a", "japanese": "あ" },
          { "latin": "i", "japanese": "い" },
          { "latin": "u", "japanese": "う" },
          { "latin": "e", "japanese": "え" },
          { "latin": "o", "japanese": "お" }
        ],

        "hiragana-k": [
          { "latin": "ka", "japanese": "か" },
          { "latin": "ki", "japanese": "き" },
          { "latin": "ku", "japanese": "く" },
          { "latin": "ke", "japanese": "け" },
          { "latin": "ko", "japanese": "こ" }
        ],

        "hiragana-s": [
          { "latin": "sa", "japanese": "さ" },
          { "latin": "shi", "japanese": "し" },
          { "latin": "su", "japanese": "す" },
          { "latin": "se", "japanese": "せ" },
          { "latin": "so", "japanese": "そ" }
        ],

        "hiragana-t": [
          { "latin": "ta", "japanese": "た" },
          { "latin": "chi", "japanese": "ち" },
          { "latin": "tsu", "japanese": "つ" },
          { "latin": "te", "japanese": "て" },
          { "latin": "to", "japanese": "と" }
        ],

        "hiragana-n": [
          { "latin": "na", "japanese": "な" },
          { "latin": "ni", "japanese": "に" },
          { "latin": "nu", "japanese": "ぬ" },
          { "latin": "ne", "japanese": "ね" },
          { "latin": "no", "japanese": "の" }
        ],

        "hiragana-h": [
          { "latin": "ha", "japanese": "は" },
          { "latin": "hi", "japanese": "ひ" },
          { "latin": "fu", "japanese": "ふ" },
          { "latin": "he", "japanese": "へ" },
          { "latin": "ho", "japanese": "ほ" }
        ]
      }

      function cloneLatinDescriptionTermTemplate() {
        return document.getElementById("latin-description-term").content.cloneNode(true);
      }

      function cloneJapaneseDescriptionDetailTemplate() {
        return document.getElementById("japanese-description-detail").content.cloneNode(true);
      }

      function cloneTranslationDescriptionListTemplate() {
        return document.getElementById("translation-description-list").content.cloneNode(true);
      }

      function renderTranslationDescriptionList(latin, japanese) {
        let latinDescriptionTermNode = cloneLatinDescriptionTermTemplate();
        latinDescriptionTermNode.querySelector("span").textContent = latin;

        let japaneseDescriptionDetailNode = cloneJapaneseDescriptionDetailTemplate();
        japaneseDescriptionDetailNode.querySelector("span").textContent = japanese;

        let translationDescriptionListNode = cloneTranslationDescriptionListTemplate();
        translationDescriptionListNode.querySelector("dt").replaceWith(latinDescriptionTermNode);
        translationDescriptionListNode.querySelector("dd").replaceWith(japaneseDescriptionDetailNode);

        return translationDescriptionListNode;
      }

      function cloneLetterGroupDescriptionTermTemplate() {
        return document.getElementById("letter-group-description-term").content.cloneNode(true);
      }

      function cloneLetterGroupDescriptionDetailTemplate() {
        return document.getElementById("letter-group-description-detail").content.cloneNode(true);
      }

      function letterGroupEnabled(groupName) {
        return getEnabledLetterGroups().includes(groupName);
      }

      function cloneLetterGroupDescriptionListTemplate() {
        return document.getElementById("letter-group-description-list").content.cloneNode(true);
      }

      function renderLetterGroupDescriptionList(groupName, groupElements) {
        let letterGroupDescriptionTermNode = cloneLetterGroupDescriptionTermTemplate();
        letterGroupDescriptionTermNode.querySelector("span").textContent = groupName;

        let letterGroupDescriptionDetailNode = cloneLetterGroupDescriptionDetailTemplate();
        letterGroupDescriptionDetailNode.querySelector("dd").replaceChildren(...groupElements.map(item => {
          let newElement = document.createElement("span")
          newElement.textContent = item["japanese"];
          return newElement;
        }));

        let letterGroupDescriptionListNode = cloneLetterGroupDescriptionListTemplate();
        letterGroupDescriptionListNode.querySelector(`input[type="checkbox"]`).setAttribute("value", groupName)
        if (letterGroupEnabled(groupName)) {
          letterGroupDescriptionListNode.querySelector(`input[type="checkbox"]`).setAttribute("checked", "checked")
        } else {
          letterGroupDescriptionListNode.querySelector(`input[type="checkbox"]`).removeAttribute("checked")
        }
        letterGroupDescriptionListNode.querySelector("dt").replaceWith(letterGroupDescriptionTermNode);
        letterGroupDescriptionListNode.querySelector("dd").replaceWith(letterGroupDescriptionDetailNode);

        return letterGroupDescriptionListNode;
      }

      function getEnabledLetterGroups() {
        return JSON.parse(localStorage.getItem("enabledLetterGroups") || "[]");
      }

      function setEnabledLetterGroups(values) {
        localStorage.setItem("enabledLetterGroups", JSON.stringify(values));
      }

      function shuffleBoard() {
        const enabledLetterGroups = getEnabledLetterGroups();

        let selectedTranslations = enabledLetterGroups.reduce((array, selectedLetterGroup) => {
          array = array.concat(translations[selectedLetterGroup] || []);
          return array;
        }, []);

        let translationDescriptionLists = [];

        for(let i = 0; i < 5; i++) {
          let randomIndex = Math.floor(Math.random() * selectedTranslations.length)
          let selectedTranslation = selectedTranslations[randomIndex]

          selectedTranslations = selectedTranslations.filter(element => element != selectedTranslation)

          translationDescriptionLists.push(
            renderTranslationDescriptionList(selectedTranslation["latin"], selectedTranslation["japanese"])
          );
        }

        document.getElementById("letters-board").replaceChildren(...translationDescriptionLists);
      }

      function toggleSolution() {
        document.querySelectorAll("#letters-board dd").forEach((element) => element.classList.toggle("hidden"));
      }

      function handleLetterGroupCheckboxClick() {
        const newEnabledLetterGroups = Array.from(
          document.querySelectorAll(".letter-group-checkbox")
        ).filter((element) => element.checked).map((element) => element.value);

        setEnabledLetterGroups(newEnabledLetterGroups);

        renderSettingsSummary();
      }

      function initUserData() {
        const enabledLetterGroups = getEnabledLetterGroups();

        if (enabledLetterGroups.length > 0) {
          setEnabledLetterGroups(enabledLetterGroups.filter((item) => translations.hasOwnProperty(item)));
        } else {
          setEnabledLetterGroups(Object.keys(translations));
        }
      }

      function renderSettingsSummary() {
        const totalGroups = Object.keys(translations).length
        const enabledGroups = getEnabledLetterGroups().length;

        const text = `${enabledGroups} of ${totalGroups} groups enabled`;

        document.querySelector("#settings-summary").textContent = text;
      }

      document.addEventListener("DOMContentLoaded", (event) => {
        initUserData();
        shuffleBoard();
        setupDialog();
        renderSettingsSummary();
      });

      function loadLetterGroupSettings() {
        let letterGroups = Object.entries(translations).map(
          ([groupName, groupElements]) => renderLetterGroupDescriptionList(groupName, groupElements)
        );

        document.getElementById("letter-groups").replaceChildren(...letterGroups);

        document.querySelectorAll(`.letter-group-checkbox`).forEach((checkboxElement) => {
          checkboxElement.addEventListener("click", handleLetterGroupCheckboxClick);
        })
      }

      function setupDialog() {
        const dialog = document.querySelector("dialog");
        const showButton = document.querySelector(".open-dialog");
        const closeButton = document.querySelector("dialog button");

        showButton.addEventListener("click", () => {
          loadLetterGroupSettings();
          dialog.showModal();
        });

        closeButton.addEventListener("click", () => dialog.close());
      }
    </script>
  </head>

  <body class="h-svh">
    <main class="h-full flex flex-col gap-y-4">
      <button class="open-dialog text-gray-400 w-8 h-8 fixed top-2 right-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
      </svg>

      </button>
      <dialog class="max-h-svh">
        <div class="flex flex-col">
          <div class="flex flex-col overflow-hidden">
            <div class="grow overflow-y-scroll max-h-96 px-8" id="letter-groups"></div>

            <div>
              <button class="min-h-16 w-full bg-blue-300 text-2xl">近い</button>
            </div>
          </div>
        </div>
      </dialog>
      <div class="text-center text-sm text-gray-500" id="settings-summary">[[SETTINGS SUMMARY]]</div>
      <div class="grow flex flex-col gap-y-4 justify-evenly" id="letters-board"></div>

      <div class="min-h-24 flex justify-center px-4 pb-2 gap-x-4">
        <button class="w-full rounded-xl bg-yellow-200 text-2xl" onclick="shuffleBoard();">シャッフル</button>
        <button class="w-full rounded-xl bg-yellow-200 text-2xl" onclick="toggleSolution();">解決</button>
      </div>
    </main>

    <template id="latin-description-term">
      <dt class="rounded-xl bg-pink-200 h-24 w-24 grid place-content-center">
        <span class="text-3xl">[[LATIN]]</span>
      </dt>
    </template>

    <template id="japanese-description-detail">
      <dd class="rounded-xl bg-pink-300 h-24 w-24 grid place-content-center hidden">
        <span class="text-3xl">[[JAPANESE]]</span>
      </dd>
    </template>

    <template id="translation-description-list">
      <dl class="inline-flex justify-center gap-x-4">
        <dt>[[LATIN-DESCRIPTION-TERM]]</dt>
        <dd>[[JAPANESE-DESCRIPTION-DETAIL]]</dd>
      </dl>
    </template>

    <template id="letter-group-description-term">
      <dt>
        <span class="text-xs opacity-70">[[LETTER-GROUP-NAME]]</span>
      </dt>
    </template>

    <template id="letter-group-description-detail">
      <dd class="text-3xl"></dd>
    </template>

    <template id="letter-group-description-list">
      <div class="flex py-4 items-end gap-4">
        <div>
          <input type="checkbox" checked class="letter-group-checkbox w-6 h-6" value="[[UNKNOWN]]" />
        </div>
        <dl class="grow">
          <dt>[[LETTER-GROUP-DESCRIPTION-TERM]]</dt>
          <dd>[[LETTER-GROUP-DESCRIPTION-DETAIL]]</dd>
        </dl>
      </div>
    </template>
  </body>
</html>
